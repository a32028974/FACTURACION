<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root{
    --bg:#f5f6f8;
    --panel:#fff;
    --line:#e5e7eb;
    --muted:#6b7280;
    --blue:#2563eb;
    --green:#16a34a;
    --pill:#f9fafb;
  }
  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
  body{ margin:0; background:var(--bg); color:#111; }

  header{
    display:flex;
    align-items:center;
    gap:14px;
    padding:10px 14px;
    background:#fff;
    border-bottom:1px solid var(--line);
    position:sticky;
    top:0;
    z-index:5;
  }
  header img{ height:42px; }
  .title{ font-weight:700; font-size:20px; margin-right:auto; }
  .badge{
    border:1px solid var(--line);
    background:#fff;
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
  }

  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
  .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    padding:14px;
    margin:12px 0;
  }
  h3{ margin:6px 0 10px; font-size:16px; }
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
  input, select{
    width:100%;
    padding:10px 12px;
    border:1px solid #d1d5db;
    border-radius:10px;
    font-size:15px;
  }

  .rowTop{
    display:grid;
    grid-template-columns:140px 1fr;
    gap:10px;
    align-items:end;
  }
  .rowBottom{
    display:grid;
    grid-template-columns:170px 150px 220px 160px;
    gap:10px;
    align-items:end;
  }

  .btn{
    padding:10px 14px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#fff;
    cursor:pointer;
  }
  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
  .btn.green{ background:var(--green); color:#fff; border-color:var(--green); }

  .pill{
    background:var(--pill);
    border:1px solid var(--line);
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
  }
  .muted{ color:var(--muted); }
  .hidden{ display:none !important; }

  .modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .modal .inner{
    width:100%;
    max-width:420px;
    background:#fff;
    border-radius:14px;
    padding:18px;
    border:1px solid var(--line);
    text-align:center;
  }
  .spinner{
    width:18px;
    height:18px;
    border:3px solid #e5e7eb;
    border-top-color:#2563eb;
    border-radius:50%;
    animation:sp .9s linear infinite;
    display:inline-block;
    margin-right:8px;
    vertical-align:middle;
  }
  @keyframes sp{ to{ transform:rotate(360deg); } }

  .two-pay{
    display:grid;
    grid-template-columns:150px 150px 150px 150px;
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:720px){
    .two-pay{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Ã“ptica Cristal">
  <div class="title">Emitir Comprobante</div>
  <div class="badge">ðŸ“… <span id="hoy"></span></div>
  <div class="badge">ðŸ‘¤ <b id="empName">â€”</b></div>
  <button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

  <!-- Fecha del comprobante -->
  <section class="card">
    <h3>Datos del Comprobante V2</h3>
    <div class="pill">Fecha: <span id="fechaHoy" style="margin-left:6px"></span></div>
  </section>

  <!-- Datos para AFIP -->
  <section class="card">
    <h3>Datos del cliente / Factura AFIP</h3>
    <div style="display:grid; grid-template-columns:150px 180px 220px 150px; gap:10px; align-items:end;">
      <div>
        <label>Tipo de documento</label>
        <select id="docTipo">
          <option value="CF">Consumidor final (CF)</option>
          <option value="CUIT">CUIT</option>
        </select>
      </div>
      <div>
        <label>NÂ° documento (para CUIT)</label>
        <input id="docNumero" placeholder="Solo nÃºmeros">
      </div>
      <div>
        <label>CondiciÃ³n frente al IVA</label>
        <select id="condIva">
          <option value="CF">Consumidor Final</option>
          <option value="RI">Resp. Inscripto</option>
          <option value="EX">Exento</option>
          <option value="MT">Monotributo</option>
        </select>
      </div>
      <div>
        <label>ImpresiÃ³n</label>
        <select id="printMode">
          <option value="A4">A4</option>
          <option value="TICKET">Ticket 80mm</option>
        </select>
      </div>
    </div>
    <p class="muted" style="margin-top:8px;font-size:12px">
      Si dejÃ¡s "Consumidor final", se usa documento 0 y condiciÃ³n IVA = CF.
    </p>
  </section>

  <!-- Conceptos a facturar -->
  <section class="card">
    <h3>Conceptos a facturar</h3>

    <div class="rowTop">
      <div>
        <label>CÃ³digo</label>
        <input id="inpCodigo" placeholder="EscaneÃ¡ o escribÃ­ y Tab/Enter">
      </div>
      <div>
        <label>DescripciÃ³n</label>
        <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
      </div>
    </div>

    <div class="rowBottom" style="margin-top:10px">
      <div>
        <label>Rubro (obligatorio)</label>
        <select id="inpRubro" required>
          <option value="">â€” Elegir rubro â€”</option>
          <option>Receta</option>
          <option>Lentes de contacto</option>
          <option>LÃ­quidos LC</option>
          <option>Reparaciones y varios</option>
          <option>Sol</option>
          <option>Fotos y pilas</option>
        </select>
      </div>
      <div>
        <label>Precio Unit.</label>
        <input type="text" id="inpUnit" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div>
        <label>Forma de pago</label>
        <select id="fdp" required>
          <option value="">â€” Elegir forma de pago â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
          <option value="__2__">2 MEDIOS DE PAGO</option>
        </select>
      </div>
      <div>
        <label style="visibility:hidden">â€”</label>
        <button class="btn blue" id="btnAgregar">Registrar venta</button>
      </div>
    </div>

    <!-- Solo si eligen 2 medios -->
    <div id="twoPayBox" class="two-pay hidden">
      <div>
        <label>Forma de pago 1</label>
        <select id="fdp1">
          <option value="">â€” Elegir â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label>Monto 1</label>
        <input type="text" id="monto1" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div>
        <label>Forma de pago 2</label>
        <select id="fdp2">
          <option value="">â€” Elegir â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label>Monto 2 (auto)</label>
        <input type="text" id="monto2" inputmode="numeric" placeholder="0" readonly>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Observaciones</label>
      <input id="obs" placeholder="">
    </div>

    <div id="msgLinea" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Ãšltimas ventas -->
  <section class="card">
    <h3>Ãšltimas ventas (3)</h3>
    <div id="ultimas" class="muted">â€”</div>
  </section>

  <!-- Panel retiros / cierre -->
  <section class="card hidden" id="panelRetiros">
    <h3>Retiros / Ingresos y Cierre (autorizado)</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr 140px; gap:10px; margin-bottom:10px;">
      <div>
        <label>Tipo</label>
        <select id="tipoMov">
          <option>Retiro de caja</option>
          <option>Ingreso a caja</option>
          <option>Pago proveedor</option>
        </select>
      </div>
      <div>
        <label>Monto</label>
        <input type="text" id="montoMov" inputmode="numeric" placeholder="0">
      </div>
      <div>
        <label>DescripciÃ³n</label>
        <input id="descMov" placeholder="Motivo">
      </div>
      <div>
        <label style="visibility:hidden">â€”</label>
        <button class="btn" id="btnMov">Registrar</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
      <div>
        <label>Fecha del cierre</label>
        <input type="date" id="cierreDate">
      </div>
      <button class="btn green" id="btnCierre">Cierre del dÃ­a (PDF)</button>
      <div id="msgMov" class="muted" style="margin-left:auto"></div>
    </div>
  </section>

</div>

<!-- Modal LOGIN -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p class="muted">EscribÃ­ tu inicial <b>cÃ³digo</b></p>
    <label>CÃ³digo de empleado</label>
    <input id="empCode" placeholder="">
    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>
</div>

<!-- Modales de progreso -->
<div class="modal hidden" id="findModal" aria-hidden="true">
  <div class="inner" style="max-width:360px;">
    <div class="spinner"></div>
    <b>Buscando artÃ­culoâ€¦</b>
    <p class="muted" style="margin:8px 0 0">Consultando el Stock</p>
  </div>
</div>

<div class="modal hidden" id="movModal" aria-hidden="true">
  <div class="inner" style="max-width:360px;">
    <div class="spinner"></div>
    <b>Registrando movimientoâ€¦</b>
    <p class="muted" style="margin:8px 0 0">Guardando en Caja</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
/* =========================
   CONFIG
   ========================= */
const API_URL          = 'https://script.google.com/macros/s/AKfycbw7UedXBTFCe3qGo8kB091e5dP0Gk_7t0jCFx1h7wg4PhF0pK8KhpOFb8cnSkLvdpxg/exec';
const FACTURA_API_URL  = 'http://localhost:4000/api/facturar';   // backend Node ARCA/AFIP
const WITHDRAW_AUTH    = ['JU','JI'];

const qs    = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));

let CURRENT_EMP = null;
let SAVING      = false;

/* =========================
   EMPLEADO
   ========================= */
function setEmp(emp){
  CURRENT_EMP = {
    codigo: String(emp.codigo || '').toUpperCase(),
    nombre: emp.nombre || ''
  };
  qs('#empName').textContent = CURRENT_EMP.nombre || 'â€”';
  toggleAutorizados();
}
function clearEmp(){
  CURRENT_EMP = null;
  qs('#empName').textContent = 'â€”';
  toggleAutorizados();
}
function getEmp(){ return CURRENT_EMP; }

/* =========================
   MODALES
   ========================= */
function showLogin(){
  clearEmp();
  qs('#loginModal').classList.remove('hidden');
  qs('#empCode').value = '';
  qs('#loginMsg').textContent = '';
  setTimeout(()=>qs('#empCode').focus(),120);
}
function hideLogin(){ qs('#loginModal').classList.add('hidden'); }

function showFinding(){ qs('#findModal').classList.remove('hidden'); }
function hideFinding(){ qs('#findModal').classList.add('hidden'); }

function showMov(){ qs('#movModal').classList.remove('hidden'); }
function hideMov(){ qs('#movModal').classList.add('hidden'); }

function showSaving(){
  Swal.fire({title:'Guardandoâ€¦',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
}
function closeSaving(){ Swal.close(); }

/* =========================
   API GOOGLE SHEETS
   ========================= */
async function apiGet(params){
  const r = await fetch(API_URL + '?' + new URLSearchParams(params).toString());
  return r.json();
}
async function apiPost(payload){
  const r = await fetch(API_URL,{
    method:'POST',
    body:JSON.stringify(payload)
  });
  return r.json();
}

/* =========================
   FORMATEO DINERO EN VIVO
   ========================= */
const nf = new Intl.NumberFormat('es-AR');

function onlyDigits(v){ return (v || '').replace(/\D+/g,''); }

function setFormatted(el, digits){
  if(digits === ''){
    el.value = '';
    el.dataset.raw = '';
    return;
  }
  const n = parseInt(digits,10);
  el.dataset.raw = String(n);
  el.value = nf.format(n);
}
function getNumber(el){
  const raw = el.dataset.raw ?? '';
  if(raw !== '') return parseInt(raw,10);
  const d = onlyDigits(el.value);
  return d ? parseInt(d,10) : 0;
}

function attachMoneyMask(sel){
  const el = qs(sel);
  el.addEventListener('input', ()=>{
    const d = onlyDigits(el.value);
    setFormatted(el,d);
    if(sel==='#inpUnit') recalcDosMedios();
  });
  el.addEventListener('blur', ()=>{
    const d = onlyDigits(el.value);
    setFormatted(el,d);
    if(sel==='#inpUnit') recalcDosMedios();
  });
}

/* =========================
   ÃšLTIMAS VENTAS / STOCK
   ========================= */
async function cargarUltimas(){
  const r = await apiGet({action:'ultimas', n:3});
  const el = qs('#ultimas');
  if(!r.ok || !r.data || r.data.length === 0){
    el.textContent = 'Sin ventas aÃºn.';
    return;
  }
  el.innerHTML = r.data.map(u =>
    `<div class="pill" style="display:block;margin:6px 0">
      ${u.hora} â€¢ ${u.emp} â€¢ ${u.fdp} â€¢ ${u.desc} â€¢ <b>${money(u.total)}</b>
     </div>`
  ).join('');
}

async function buscarStock(num){
  const r = await apiGet({action:'stock_get', num});
  return r.ok ? r.data : null;
}

async function lookupDesdeCodigo(e){
  if(e.key!=='Enter' && e.key!=='Tab') return;
  e.preventDefault();
  const code = (qs('#inpCodigo').value || '').trim();
  if(!code){ qs('#inpDesc').focus(); return; }
  showFinding();
  try{
    const it = await buscarStock(code);
    if(it){
      qs('#inpDesc').value = it.descripcion || '';
      setFormatted(qs('#inpUnit'), String(parseInt(it.precio || 0,10)));
      recalcDosMedios();
    }
  }finally{
    hideFinding();
    qs('#inpDesc').focus();
  }
}

/* =========================
   DOS MEDIOS DE PAGO
   ========================= */
function toggleTwoPay(){
  const two = qs('#fdp').value === '__2__';
  qs('#twoPayBox').classList.toggle('hidden', !two);

  if(!two){
    qs('#fdp1').value=''; qs('#fdp2').value='';
    setFormatted(qs('#monto1'),'');
    setFormatted(qs('#monto2'),'');
  }else{
    const total = getNumber(qs('#inpUnit'));
    setFormatted(qs('#monto1'),'0');
    setFormatted(qs('#monto2'), String(total));
  }
}

function recalcDosMedios(){
  if(qs('#fdp').value !== '__2__') return;
  const total = getNumber(qs('#inpUnit'));
  let m1 = getNumber(qs('#monto1'));
  if(m1 < 0) m1 = 0;
  if(m1 > total) m1 = total;
  setFormatted(qs('#monto1'), String(m1));
  setFormatted(qs('#monto2'), String(Math.max(total - m1,0)));
}

/* =========================
   HELPERS
   ========================= */
function limpiarCamposVenta(){
  qs('#inpCodigo').value='';
  qs('#inpDesc').value='';
  setFormatted(qs('#inpUnit'),'');
  qs('#inpRubro').value='';
  qs('#fdp').value='';
  qs('#obs').value='';
  toggleTwoPay();
}

/* =========================
   FACTURACIÃ“N AFIP (ARCA)
   ========================= */
function pad(num,len){ return String(num).padStart(len,'0'); }

function abrirTicketAfip({fact,descFinal,total,fdp,tipoDocSel,documento,condicion}){
  const mode  = (qs('#printMode').value || 'A4').toUpperCase();
  const ancho = mode === 'TICKET' ? '78mm' : '190mm';
  const emp   = getEmp();
  const hoy   = new Date();
  const fechaStr = hoy.toLocaleString('es-AR');
  const ptoVta   = fact.punto_venta ?? 6;
  const numCbte  = fact.numero ?? 0;
  const nroComp  = pad(ptoVta,4) + '-' + pad(numCbte,8);

  const w = window.open('', '_blank');
  if(!w){
    alert('No se pudo abrir la ventana de impresiÃ³n (popup bloqueado).');
    return;
  }

  w.document.open();
  w.document.write(`<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Factura AFIP</title>
<style>
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Arial,sans-serif;}
  body{margin:0;padding:10px;display:flex;justify-content:center;}
  .ticket{width:${ancho};}
  h1{font-size:16px;margin:0 0 4px;}
  h2{font-size:14px;margin:4px 0;}
  .muted{color:#555;font-size:11px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
  th,td{border-top:1px solid #ccc;padding:4px 0;text-align:left;}
  .right{text-align:right;}
  .tot{margin-top:8px;font-size:14px;font-weight:bold;text-align:right;}
  .small{font-size:11px;}
</style>
</head>
<body>
<div class="ticket">
  <h1>Ã“ptica Cristal</h1>
  <div class="muted small">San Miguel - Buenos Aires</div>
  <div class="muted small">Fecha: ${fechaStr}</div>
  <h2>Factura B</h2>
  <div class="small">Comp.: ${nroComp}</div>
  <div class="small">CAE: ${fact.cae}</div>
  <div class="small">Vto CAE: ${fact.cae_vto}</div>
  <hr>
  <div class="small">Cliente: ${tipoDocSel === 'CF' ? 'Consumidor Final' : documento}</div>
  <div class="small">Cond. IVA: ${condicion}</div>
  <div class="small">Vendedor: ${(emp && emp.nombre) || ''}</div>
  <table>
    <thead><tr><th>DescripciÃ³n</th><th class="right">Importe</th></tr></thead>
    <tbody><tr><td>${descFinal}</td><td class="right">${money(total)}</td></tr></tbody>
  </table>
  <div class="tot">Total: ${money(total)}</div>
  <div class="small">Forma de pago: ${fdp}</div>
</div>
<script>window.print();<\/script>
</body>
</html>`);
  w.document.close();
}

async function facturarElectronico({descFinal,total,fdpSel}){
  const tipoDocSel = (qs('#docTipo').value || 'CF').toUpperCase();
  let   documento  = (qs('#docNumero').value || '').replace(/\D+/g,'');
  const condicion  = (qs('#condIva').value || 'CF').toUpperCase();

  if(tipoDocSel === 'CF'){
    documento = '0';
  }else{
    if(!documento){
      throw new Error('Para tipo de documento CUIT tenÃ©s que ingresar el nÃºmero.');
    }
  }

  const payload = {
    descripcion:   descFinal,
    importe:       total,
    documento,
    tipo_doc:      tipoDocSel,
    condicion_iva: condicion,
    forma_pago:    fdpSel === '__2__' ? 'MIXTO' : fdpSel
  };

  const resp = await fetch(FACTURA_API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  let data;
  try{
    data = await resp.json();
  }catch(e){
    throw new Error('Respuesta invÃ¡lida del servidor de facturaciÃ³n.');
  }

  if(!resp.ok || !data.ok){
    throw new Error((data && data.error) || 'No se pudo emitir la factura electrÃ³nica.');
  }

  abrirTicketAfip({
    fact:data,
    descFinal,
    total,
    fdp:payload.forma_pago,
    tipoDocSel,
    documento,
    condicion
  });

  return data;
}

/* =========================
   GUARDAR VENTA
   ========================= */
async function guardarVenta(){
  if(SAVING) return;
  const emp = getEmp();
  if(!emp){ showLogin(); return; }

  const codigo = (qs('#inpCodigo').value || '').trim();
  const rubro  = qs('#inpRubro').value;
  const desc   = (qs('#inpDesc').value || '').trim();
  const total  = getNumber(qs('#inpUnit'));
  const fdpSel = qs('#fdp').value;
  const obs    = (qs('#obs').value || '').trim();

  if(!rubro){
    Swal.fire('Falta rubro','ElegÃ­ un rubro.','warning');
    qs('#inpRubro').focus();
    return;
  }
  if(!fdpSel){
    Swal.fire('Falta forma de pago','ElegÃ­ la forma de pago.','warning');
    qs('#fdp').focus();
    return;
  }
  if(!desc || total <= 0){
    Swal.fire('Faltan datos','CompletÃ¡ descripciÃ³n y precio > 0.','warning');
    if(!desc) qs('#inpDesc').focus(); else qs('#inpUnit').focus();
    return;
  }

  const descFinal = `${rubro}: ${desc}`.trim();

  try{
    SAVING = true;
    qs('#btnAgregar').disabled = true;
    showSaving();

    // 1) Guardar en Sheets (igual que antes)
    if(fdpSel !== '__2__'){
      const res = await apiPost({
        action:'venta_add',
        empleadoCodigo: emp.codigo,
        fdp: fdpSel,
        monto: total,
        numItem: codigo,
        precioItem: total,
        descripcion: descFinal,
        obs
      });
      if(!res.ok) throw new Error(res.error || 'No se pudo guardar.');
    }else{
      const f1 = qs('#fdp1').value;
      const f2 = qs('#fdp2').value;
      const m1 = getNumber(qs('#monto1'));
      const m2 = getNumber(qs('#monto2'));

      if(!f1 || !f2) throw new Error('ElegÃ­ ambas formas de pago.');
      if(m1 + m2 !== total) throw new Error('La suma de montos debe igualar el total.');

      const r1 = await apiPost({
        action:'venta_add',
        empleadoCodigo: emp.codigo,
        fdp: f1,
        monto: m1,
        numItem: codigo,
        precioItem: total,
        descripcion: descFinal,
        obs
      });
      if(!r1.ok) throw new Error(r1.error || 'No se pudo guardar el primer pago.');

      const r2 = await apiPost({
        action:'venta_add',
        empleadoCodigo: emp.codigo,
        fdp: f2,
        monto: m2,
        numItem: codigo,
        precioItem: 0,
        descripcion: descFinal,
        obs
      });
      if(!r2.ok) throw new Error(r2.error || 'No se pudo guardar el segundo pago.');
    }

    // 2) Factura electrÃ³nica
    try{
      await facturarElectronico({descFinal,total,fdpSel});
    }catch(e){
      console.error('Error facturaciÃ³n AFIP:', e);
      await Swal.fire(
        'Venta guardada, peroâ€¦',
        (e && e.message) || 'No se pudo emitir la factura electrÃ³nica.',
        'warning'
      );
    }

    qs('#btnAgregar').disabled = false;
    SAVING = false;
    closeSaving();

    await cargarUltimas();
    limpiarCamposVenta();
    Swal.fire({icon:'success',title:'Venta registrada',timer:900,showConfirmButton:false});
    setTimeout(()=>showLogin(),650);

  }catch(e){
    qs('#btnAgregar').disabled = false;
    SAVING = false;
    closeSaving();
    Swal.fire('Error', e.message || 'No se pudo guardar.', 'error');
  }
}

/* =========================
   RETIROS / CIERRE
   ========================= */
function toggleAutorizados(){
  const emp = getEmp();
  const isAuth = !!(emp && WITHDRAW_AUTH.includes((emp.codigo || '').toUpperCase()));
  qs('#panelRetiros').classList.toggle('hidden', !isAuth);
}

async function registrarMov(){
  const emp = getEmp();
  if(!emp){ showLogin(); return; }

  showMov();
  try{
    const monto = getNumber(qs('#montoMov'));
    const res = await apiPost({
      action:'mov_add',
      empleadoCodigo: emp.codigo,
      tipo: qs('#tipoMov').value,
      monto,
      descripcion: qs('#descMov').value.trim()
    });
    if(res.ok){
      setFormatted(qs('#montoMov'),'');
      qs('#descMov').value = '';
      Swal.fire({icon:'success',title:'Movimiento registrado',timer:1100,showConfirmButton:false});
    }else{
      Swal.fire('Error', res.error || 'No se pudo guardar el movimiento','error');
    }
  }catch(e){
    Swal.fire('Error de red', e.message || 'FallÃ³ la conexiÃ³n','error');
  }finally{
    hideMov();
  }
}

async function generarCierre(){
  const emp = getEmp();
  if(!emp){ showLogin(); return; }
  if(!WITHDRAW_AUTH.includes(emp.codigo)){
    Swal.fire('No autorizado','','warning');
    return;
  }

  const d = qs('#cierreDate').value || new Date().toISOString().slice(0,10);

  Swal.fire({title:'Generando PDFâ€¦',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  try{
    const r = await apiGet({action:'cierre_pdf', code:emp.codigo, date:d});
    Swal.close();

    if(r.ok && r.data && r.data.url){
      window.open(r.data.url,'_blank');
      Swal.fire('Cierre generado', r.data.name || 'Listo para imprimir', 'success');
    }else{
      Swal.fire('Error', (r && r.error) || 'No se pudo generar el PDF', 'error');
    }
  }catch(e){
    Swal.close();
    Swal.fire('Error de red', e.message || 'FallÃ³ la conexiÃ³n','error');
  }
}

/* =========================
   LOGIN
   ========================= */
async function doLogin(){
  const code = (qs('#empCode').value || '').trim().toUpperCase();
  if(!code) return;
  qs('#loginMsg').textContent = 'Verificando empleado...';
  const r = await apiGet({action:'login', code});
  const m = qs('#loginMsg');
  if(r.ok){
    setEmp(r.data);
    m.textContent = '';
    hideLogin();
    qs('#inpCodigo').focus();
  }else{
    m.textContent = r.error || 'CÃ³digo invÃ¡lido';
  }
}

/* =========================
   INIT
   ========================= */
function init(){
  const d = new Date();
  qs('#hoy').textContent = d.toLocaleDateString('es-AR',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});
  qs('#fechaHoy').textContent = d.toLocaleDateString('es-AR');

  attachMoneyMask('#inpUnit');
  attachMoneyMask('#monto1');
  attachMoneyMask('#monto2');
  attachMoneyMask('#montoMov');

  qs('#inpCodigo').addEventListener('keydown', lookupDesdeCodigo);
  qs('#inpDesc').addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      qs('#inpUnit').focus();
    }
  });

  qs('#fdp').addEventListener('change', ()=>{
    toggleTwoPay();
    recalcDosMedios();
  });
  qs('#monto1').addEventListener('input', recalcDosMedios);

  qs('#btnAgregar').onclick = guardarVenta;
  qs('#btnMov').onclick     = registrarMov;
  qs('#btnCierre').onclick  = generarCierre;

  qs('#btnLogin').onclick = doLogin;
  qs('#empCode').addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      doLogin();
    }
  });
  qs('#btnCambiar').onclick = showLogin;

  // Atajo F9
  document.addEventListener('keydown', e=>{
    if(e.key === 'F9' || e.keyCode === 120){
      e.preventDefault();
      guardarVenta();
    }
  });

  showLogin();

  // Siempre enfocar el input del login cuando se abre
  const modal = qs('#loginModal');
  new MutationObserver(()=>{
    setTimeout(()=>qs('#empCode').focus(),120);
  }).observe(modal,{attributes:true,attributeFilter:['class']});

  cargarUltimas();
}

init();
</script>
</body>
</html>
