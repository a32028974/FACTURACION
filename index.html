<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root{ --bg:#f5f6f8; --panel:#fff; --line:#e5e7eb; --muted:#6b7280; --blue:#2563eb; --green:#16a34a; --pill:#f9fafb; }
  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
  body{ margin:0; background:var(--bg); color:#111; }
  header{ display:flex; align-items:center; gap:14px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5;}
  header img{ height:42px; }
  .title{ font-weight:700; font-size:20px; margin-right:auto; }
  .badge{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
  h3{ margin:6px 0 10px; font-size:16px; }
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
  input, select{ width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; }
  .rowTop{ display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:end; }
  .rowBottom{ display:grid; grid-template-columns:170px 150px 220px 160px; gap:10px; align-items:end; }
  .btn{ padding:10px 14px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
  .btn.green{ background:var(--green); color:#fff; border-color:var(--green); }
  .pill{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; }
  .muted{ color:var(--muted); }
  .hidden{ display:none !important; }

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
  .modal .inner{ width:100%; max-width:420px; background:#fff; border-radius:14px; padding:18px; border:1px solid var(--line); text-align:center;}
  .spinner{ width:18px; height:18px; border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:50%; animation:sp .9s linear infinite; display:inline-block; margin-right:8px; vertical-align:middle;}
  @keyframes sp{to{transform:rotate(360deg)}}

  .two-pay{ display:grid; grid-template-columns:150px 150px 150px 150px; gap:10px; margin-top:10px; }
  @media (max-width:720px){
    .two-pay{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="Ã“ptica Cristal">
  <div class="title">Emitir Comprobante</div>
  <div class="badge">ðŸ“… <span id="hoy"></span></div>
  <div class="badge">ðŸ‘¤ <b id="empName">â€”</b></div>
  <button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

  <section class="card">
    <h3>Datos del Comprobante </h3>
    <div class="pill">Fecha: <span id="fechaHoy" style="margin-left:6px"></span></div>
  </section>

  <!-- ðŸ”¹ NUEVA SECCIÃ“N: DATOS PARA AFIP -->
  <section class="card">
    <h3>Datos del cliente / Factura AFIP</h3>
    <div style="display:grid; grid-template-columns:150px 180px 220px 150px; gap:10px; align-items:end;">
      <div>
        <label>Tipo de documento</label>
        <select id="docTipo">
          <option value="CF">Consumidor final (CF)</option>
          <option value="CUIT">CUIT</option>
        </select>
      </div>
      <div>
        <label>NÂ° documento (para CUIT)</label>
        <input id="docNumero" placeholder="Solo nÃºmeros">
      </div>
      <div>
        <label>CondiciÃ³n frente al IVA</label>
        <select id="condIva">
          <option value="CF">Consumidor Final</option>
          <option value="RI">Resp. Inscripto</option>
          <option value="EX">Exento</option>
          <option value="MT">Monotributo</option>
        </select>
      </div>
      <div>
        <label>ImpresiÃ³n</label>
        <select id="printMode">
          <option value="A4">A4</option>
          <option value="TICKET">Ticket 80mm</option>
        </select>
      </div>
    </div>
    <p class="muted" style="margin-top:8px;font-size:12px">
      Si dejÃ¡s "Consumidor final", se usa documento 0 y condiciÃ³n IVA = CF.
    </p>
  </section>
  <!-- ðŸ”¹ FIN SECCIÃ“N AFIP -->

  <section class="card">
    <h3>Conceptos a facturar</h3>

    <div class="rowTop">
      <div>
        <label>CÃ³digo</label>
        <input id="inpCodigo" placeholder="EscaneÃ¡ o escribÃ­ y Tab/Enter">
      </div>
      <div>
        <label>DescripciÃ³n</label>
        <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
      </div>
    </div>

    <div class="rowBottom" style="margin-top:10px">
      <div>
        <label>Rubro (obligatorio)</label>
        <select id="inpRubro" required>
          <option value="">â€” Elegir rubro â€”</option>
          <option>Receta</option>
          <option>Lentes de contacto</option>
          <option>LÃ­quidos LC</option>
          <option>Reparaciones y varios</option>
          <option>Sol</option>
          <option>Fotos y pilas</option>
        </select>
      </div>
      <div>
        <label>Precio Unit.</label>
        <!-- Cambiado a text para poder formatear con puntos -->
        <input type="text" id="inpUnit" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div>
        <label>Forma de pago</label>
        <select id="fdp" required>
          <option value="">â€” Elegir forma de pago â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
          <option value="__2__">2 MEDIOS DE PAGO</option>
        </select>
      </div>
      <div>
        <label style="visibility:hidden">â€”</label>
        <button class="btn blue" id="btnAgregar">Registrar venta</button>
      </div>
    </div>

    <!-- Solo aparece si se elige "2 MEDIOS DE PAGO" -->
    <div id="twoPayBox" class="two-pay hidden">
      <div>
        <label>Forma de pago 1</label>
        <select id="fdp1">
          <option value="">â€” Elegir â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label>Monto 1</label>
        <input type="text" id="monto1" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div>
        <label>Forma de pago 2</label>
        <select id="fdp2">
          <option value="">â€” Elegir â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label>Monto 2 (auto)</label>
        <input type="text" id="monto2" inputmode="numeric" placeholder="0" readonly>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Observaciones</label>
      <input id="obs" placeholder="">
    </div>

    <div id="msgLinea" class="muted" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3>Ãšltimas ventas (3)</h3>
    <div id="ultimas" class="muted">â€”</div>
  </section>

  <section class="card hidden" id="panelRetiros">
    <h3>Retiros / Ingresos y Cierre (autorizado)</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr 140px; gap:10px; margin-bottom:10px;">
      <div>
        <label>Tipo</label>
        <select id="tipoMov">
          <option>Retiro de caja</option>
          <option>Ingreso a caja</option>
          <option>Pago proveedor</option>
        </select>
      </div>
      <div>
        <label>Monto</label>
        <input type="text" id="montoMov" inputmode="numeric" placeholder="0">
      </div>
      <div>
        <label>DescripciÃ³n</label>
        <input id="descMov" placeholder="Motivo">
      </div>
      <div>
        <label style="visibility:hidden">â€”</label>
        <button class="btn" id="btnMov">Registrar</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
      <div>
        <label>Fecha del cierre</label>
        <input type="date" id="cierreDate">
      </div>
      <button class="btn green" id="btnCierre">Cierre del dÃ­a (PDF)</button>
      <div id="msgMov" class="muted" style="margin-left:auto"></div>
    </div>
  </section>

</div>

<!-- Modal LOGIN -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p class="muted">EscribÃ­ tu inicial <b>cÃ³digo</b></p>
    <label>CÃ³digo de empleado</label>
    <input id="empCode" placeholder="">
    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>
</div>

<!-- Modales de progreso -->
<div class="modal hidden" id="findModal" aria-hidden="true">
  <div class="inner" style="max-width:360px;">
    <div class="spinner"></div>
    <b>Buscando artÃ­culoâ€¦</b>
    <p class="muted" style="margin:8px 0 0">Consultando el Stock</p>
  </div>
</div>
<div class="modal hidden" id="movModal" aria-hidden="true">
  <div class="inner" style="max-width:360px;">
    <div class="spinner"></div>
    <b>Registrando movimientoâ€¦<
